---
output: reprex::reprex_document
knit: reprex::reprex_render
---

# Packages

Let's first load in the packages needed for this task using the `library()` function.

```{r}
library(tidyverse)
library(visdat)
library(lme4)
library(lmerTest)
library(emmeans)
library(buildmer)
library(performance)
```

We then read in our dataset using the `read_csv()` function.

```{r}
raw_data <- read_csv("raw_data.csv")
```

We can use the `vis_miss()` function from the library `visdat` to identify any areas which are missing data.

```{r}
vis_miss(raw_data)
```

`vis_miss()` creates a visualisation of all the missing data in our dataset and shows us where the data are missing. It appears as though all the values below 150 are missing. This is not surprising, considering that we were given a sample dataset of 500. We can also see that there are columnms which contain only `NA` values. The code below creates a new dataset containing only the first 500 rows, as well as the columns which contain at least 1 non-NA observation.

```{r}
data <- head(raw_data, 500) # We select only the first 500 rows
data <- data %>%
    mutate(TRANS_DATE = MONTH) %>%
    select(!MONTH)
data <- data[, colSums(is.na(data)) < nrow(data)] # We remove columns which are all NA
data$LOYALTY <- toupper(data$LOYALTY) # We made all the labels for LOYALTY upper case
data <- data %>%
    mutate(LOYALTY = factor(LOYALTY)) # We factorise LOYALTY

# We run an if statement to see if CUST_AREA and CUST_REGION are identical. If so, we remove CUST_AREA
if (all(sapply(list(data$CUST_AREA, data$CUST_REGION), FUN = identical, data$REGION)) == TRUE) {
    data <- data %>%
        select(!CUST_AREA & !CUST_REGION)
}
```

Let's have another look at the missing data using `vis_miss()`

```{r}
vis_miss(data)
```

This is better - the appropriate NA data have been removed. We can view the first 10 observations using the `head()` function

```{r}
head(data, 10)
```

Interestingly, it appears as though `CUST_REGION` and `CUST_AREA` may be identical. We can use the `identical` function to asseess this claim.

We can see that they are, in fact, identical. Let's remove the `CUST_AREA` column from the dataset

```{r}
data %>%
    ggplot(aes(x = LOYALTY, y = VALUE, colour = LOYALTY)) +
    geom_violin(width = 0.5, lwd = 0.7) +
    geom_point(alpha = 0.2,
        position = position_jitter(width = 0.08, seed = 42)) +
    guides(fill = "none") +
    stat_summary(fun.data = "mean_cl_boot", colour = "black") +
    labs(x = "Customer Loyalty",
        y = "Item Value",
        title = "Effect of Customer Loyalty on Item Value") +
        theme_minimal()
```

```{r}
ggplot(summary_stats, aes(x = LOYALTY, y = mean_sale, fill = LOYALTY)) +
    geom_col() +
    theme_minimal() +
    guides(fill = "none") +
    labs(x = "CUSTOMER LOYALTY",
        y = "Mean Total Spent",
        title = "The Effect of Customer Loyalty on Mean Money Spent")
```

# Building Our Models

Let's build a linear model to assess whether `LOYALTY` had a significant effect on `TOTAL_COST`

```{r}
loyal_model <- buildmer(VALUE ~ LOYALTY +
    (1 + LOYALTY | LOYALTY_ID) +
    (1 + LOYALTY | TRANS_ID) +
    (1 + LOYALTY | NO_OF_ITEMS) +
    (1 + LOYALTY | ITEM_VOL) +
    (1 + LOYALTY | LOYALTY_ID) +
    (1 + LOYALTY | DELIVERY_METHOD) +
    (1 + LOYALTY | DELIVERY_COST) +
    (1 + LOYALTY | ITEM_VOLUME),
    buildmerControl = buildmerControl(direction = "order"),
    data = data)
summary(loyal_model)
```

It appears as though `LOYALTY` did not have a significant effect on `VALUE` of item (*p* = .191)

# Region

Let's have a look at some summary stats for `REGION`. 

```{r}
(reg_sum <- data %>%
    filter(REGION == "GL" | REGION == "WM") %>%
    group_by(TRANS_DATE) %>%
    summarise(mean = mean(VALUE), sd = sd(VALUE)) %>%
    arrange(-mean))
```

```{r}
reg_sum %>%
    mutate(TRANS_DATE = fct_relevel(TRANS_DATE,
            "Jan-19", "Mar-19", "Apr-19",
            "May-19", "Jun-19", "Jul-19",
            "Aug-19", "Sep-19", "Oct-19",
            "Nov-19", "Dec-19")) %>%
    ggplot(aes(x = TRANS_DATE, y = mean, fill = TRANS_DATE)) +
    geom_col() +
    geom_vline(xintercept = "Aug-19",
                linetype = "dotted",
                colour = "red",
                size = 2) +
    geom_text(aes(x = "Aug-19",
                y = 60),
                label = "Promotion\n Introduced",
                angle = 45,
                size = 10) +
    guides(fill = "none") +
    theme_minimal() +
    labs(x = "Transaction Date",
        y = "Mean Item Value",
        title = "Mean Amount of Money Spent in GL and WM Over the Previous Year") +
    theme(text = element_text(size = 15))
```

data %>%
    filter(REGION == "GL") %>%
    mutate(TRANS_DATE = fct_relevel(TRANS_DATE,
            "Jan-19", "Feb-19", "Mar-19",
            "Jun-19", "Jul-19", "Aug-19",
            "Sep-19", "Oct-19", "Nov-19",
            "Dec-19")) %>%
    summarise(mean = mean(VALUE))

Our next model assesses whether `REGION` had a significant effect on VALUE


```{r}
region_model <- buildmer(VALUE ~ REGION +
    (1 + REGION | LOYALTY_ID) +
    (1 + REGION | TRANS_ID) +
    (1 + REGION | NO_OF_ITEMS) +
    (1 + REGION | ITEM_VOL) +
    (1 + REGION | LOYALTY_ID) +
    (1 + REGION | DELIVERY_METHOD) +
    (1 + REGION | DELIVERY_COST) +
    (1 + REGION | ITEM_VOLUME),
    buildmerControl = buildmerControl(direction = "order"),
    data = data)
summary(region_model)
```

This final model examines any interactions between LOYALTY and REGION on VALUE. 

```{r}
mixed_model <- buildmer(VALUE ~ LOYALTY * REGION +
    (1 + LOYALTY * REGION | LOYALTY_ID) +
    (1 + LOYALTY * REGION | TRANS_ID) +
    (1 + LOYALTY * REGION | NO_OF_ITEMS) +
    (1 + LOYALTY * REGION | ITEM_VOL) +
    (1 + LOYALTY * REGION | LOYALTY_ID) +
    (1 + LOYALTY * REGION | DELIVERY_METHOD) +
    (1 + LOYALTY * REGION | DELIVERY_COST) +
    (1 + LOYALTY * REGION | ITEM_VOLUME),
    buildmerControl = buildmerControl(direction = "order"),
    data = data)
summary(mixed_model)
```